rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Helper Functions ---
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function isRole(role) {
      return isAuthenticated() && getUserData().role == role;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Helper to ensure user only updates their own non-sensitive fields
    function isOwnerSafeUpdate(userId) {
      return isOwner(userId) &&
        request.resource.data.diff(resource.data).affectedKeys()
        .hasOnly(['name', 'email', 'phone', 'avatar', 'birthDate', 'mustChangePassword']);
    }

    // Helper to validate message updates by sender
    function isMessageSenderUpdate() {
      return resource.data.senderId == request.auth.uid &&
             request.resource.data.senderId == request.auth.uid && // No transfer
             request.resource.data.receiverId == resource.data.receiverId && // No redirect
             request.resource.data.diff(resource.data).affectedKeys()
               .hasOnly(['subject', 'content', 'attachments', 'archived', 'updatedAt']);
    }

    // Helper to validate message updates by receiver (read status)
    function isMessageReceiverUpdate() {
      return resource.data.receiverId == request.auth.uid &&
             request.resource.data.senderId == resource.data.senderId && // No spoofing
             request.resource.data.receiverId == request.auth.uid && // No redirect
             request.resource.data.diff(resource.data).affectedKeys()
               .hasOnly(['read', 'archived', 'updatedAt']);
    }

    function isTeacher() { return isRole('teacher'); }
    function isDirector() { return isRole('director'); }
    function isParent() { return isRole('parent'); }
    function isStudent() { return isRole('student'); }
    function isSuperAdmin() { return isRole('superadmin'); }

    // New Helper: Check if score is valid (0 <= score <= maxScore)
    function isValidGrade() {
      let score = request.resource.data.score;
      let max = request.resource.data.maxScore;
      return score >= 0 && score <= max;
    }

    // New Helper: Check if user can read another user's profile
    // Allow reading if:
    // 1. It's my own profile
    // 2. I'm a teacher/director/admin (staff)
    // 3. We are in the same class (for students)
    function canReadUserProfile(targetUserData) {
       return isOwner(targetUserData.id) ||
              isTeacher() ||
              isDirector() ||
              isSuperAdmin() ||
              (isStudent() && getUserData().classId == targetUserData.classId);
    }

    // --- Collection Rules ---

    // Users:
    // - Read: Restricted to own profile, staff, or classmates.
    // - Write: Users can update their own phone/avatar/name (whitelisted fields). Directors/Admins can manage all.
    match /users/{userId} {
      // Improved Read Rule:
      allow read: if isAuthenticated() && (
        isOwner(userId) ||
        isTeacher() ||
        isDirector() ||
        isSuperAdmin() ||
        (isStudent() && getUserData().classId == resource.data.classId)
      );

      allow create, delete: if isDirector() || isSuperAdmin();

      // ðŸ›¡ï¸ SECURITY: Prevent Privilege Escalation
      // Only allow users to update their own profile fields.
      // Critical: Prevent updating 'role', 'classId', 'childrenIds', etc.
      allow update: if isDirector() || isSuperAdmin() || isOwnerSafeUpdate(userId);
    }

    // Grades (Legacy Collection Group):
    // - Read: User sees their own. Parents see their children's. Teachers see grades they gave or for their classes.
    // - Write: Teachers can add/edit grades.
    match /grades/{gradeId} {
      allow read: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid || 
        (isParent() && resource.data.studentId in getUserData().childrenIds) ||
        isTeacher() || 
        isDirector()
      );
      // Improved Write Rule: Validate Score Range
      allow write: if (isTeacher() || isDirector()) && isValidGrade();
    }

    // CourseGrades (New Collection):
    match /courseGrades/{gradeId} {
      allow read: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid ||
        (isParent() && resource.data.studentId in getUserData().childrenIds) ||
        isTeacher() ||
        isDirector()
      );
      // Improved Write Rule: Validate Score Range
      allow write: if (isTeacher() || isDirector()) && isValidGrade();
    }

    // Attendance:
    // - Similar to Grades.
    match /attendance/{attendanceId} {
      allow read: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid || 
        (isParent() && resource.data.studentId in getUserData().childrenIds) ||
        isTeacher() || 
        isDirector()
      );
      allow write: if isTeacher() || isDirector(); // Teachers modify attendance
    }

    // Homework:
    // - Read: Students in key class, Parents of students in key class, Teachers.
    // - Write: Teachers.
    match /homeworks/{homeworkId} {
      allow read: if isAuthenticated() && (
        isTeacher() ||
        isDirector() ||
        isSuperAdmin() ||
        (isStudent() && getUserData().classId == resource.data.classId) ||
        (isParent() && resource.data.classId in getUserData().relatedClassIds)
      );
      allow write: if isTeacher() || isDirector() || isSuperAdmin();
    }

    // Courses/Schedule:
    // - Read: All authenticated.
    // - Write: Director sets schedule.
    match /courses/{courseId} {
      allow read: if isAuthenticated();
      allow write: if isDirector() || isSuperAdmin();
    }

    // Classes:
    // - Read: All.
    // - Write: Director.
    match /classes/{classId} {
      allow read: if isAuthenticated();
      allow write: if isDirector() || isSuperAdmin();
    }

    // Messages:
    // - Read: Sender or Receiver.
    // - Write: Sender must be auth user and match senderId.
    match /messages/{messageId} {
      allow read: if isAuthenticated() && (
        resource.data.senderId == request.auth.uid || 
        resource.data.receiverId == request.auth.uid ||
        resource.data.receiverId == 'all' // Public announcements
      );
      allow create: if isAuthenticated() &&
        request.resource.data.senderId == request.auth.uid &&
        (
          request.resource.data.receiverId != 'all' ||
          isDirector() ||
          isSuperAdmin()
        );

      // ðŸ›¡ï¸ SECURITY: Prevent Impersonation & Content Tampering
      // - Sender can update content (but not senderId/receiverId)
      // - Receiver can mark as read/archived (but not change content)
      allow update: if isAuthenticated() && (isMessageSenderUpdate() || isMessageReceiverUpdate());

      // Only sender can delete (hard delete)
      allow delete: if isAuthenticated() && resource.data.senderId == request.auth.uid;
    }
    
    // Events:
    // - Read: Authenticated.
    // - Write: Teachers/Directors.
    match /events/{eventId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isDirector();
    }

    // Academic Periods & Categories (Bulletin System)
    match /academicPeriods/{periodId} {
      allow read: if isAuthenticated();
      allow write: if isDirector() || isSuperAdmin();
    }
    match /gradeCategories/{categoryId} {
      allow read: if isAuthenticated();
      allow write: if isDirector() || isSuperAdmin();
    }
  }
}
